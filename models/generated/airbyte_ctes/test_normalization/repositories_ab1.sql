{{ config(
    cluster_by = "_airbyte_emitted_at",
    partition_by = {"field": "_airbyte_emitted_at", "data_type": "timestamp", "granularity": "day"},
    unique_key = '_airbyte_ab_id',
    schema = "_airbyte_test_normalization",
    tags = [ "top-level-intermediate" ]
) }}
-- SQL model to parse JSON blob stored in a single column and extract into separated field columns as described by the JSON Schema
-- depends_on: {{ source('test_normalization', '_airbyte_raw_repositories') }}
select
    {{ json_extract_scalar('_airbyte_data', ['id'], ['id']) }} as id,
    {{ json_extract_scalar('_airbyte_data', ['url'], ['url']) }} as url,
    {{ json_extract_scalar('_airbyte_data', ['fork'], ['fork']) }} as fork,
    {{ json_extract_scalar('_airbyte_data', ['name'], ['name']) }} as name,
    {{ json_extract_scalar('_airbyte_data', ['size'], ['size']) }} as size,
    {{ json_extract('table_alias', '_airbyte_data', ['owner'], ['owner']) }} as owner,
    {{ json_extract_array('_airbyte_data', ['topics'], ['topics']) }} as topics,
    {{ json_extract_scalar('_airbyte_data', ['git_url'], ['git_url']) }} as git_url,
    {{ json_extract('table_alias', '_airbyte_data', ['license'], ['license']) }} as license,
    {{ json_extract_scalar('_airbyte_data', ['node_id'], ['node_id']) }} as node_id,
    {{ json_extract_scalar('_airbyte_data', ['private'], ['private']) }} as private,
    {{ json_extract_scalar('_airbyte_data', ['ssh_url'], ['ssh_url']) }} as ssh_url,
    {{ json_extract_scalar('_airbyte_data', ['svn_url'], ['svn_url']) }} as svn_url,
    {{ json_extract_scalar('_airbyte_data', ['archived'], ['archived']) }} as archived,
    {{ json_extract_scalar('_airbyte_data', ['disabled'], ['disabled']) }} as disabled,
    {{ json_extract_scalar('_airbyte_data', ['has_wiki'], ['has_wiki']) }} as has_wiki,
    {{ json_extract_scalar('_airbyte_data', ['homepage'], ['homepage']) }} as homepage,
    {{ json_extract_scalar('_airbyte_data', ['html_url'], ['html_url']) }} as html_url,
    {{ json_extract_scalar('_airbyte_data', ['keys_url'], ['keys_url']) }} as keys_url,
    {{ json_extract_scalar('_airbyte_data', ['language'], ['language']) }} as language,
    {{ json_extract_scalar('_airbyte_data', ['tags_url'], ['tags_url']) }} as tags_url,
    {{ json_extract_scalar('_airbyte_data', ['blobs_url'], ['blobs_url']) }} as blobs_url,
    {{ json_extract_scalar('_airbyte_data', ['clone_url'], ['clone_url']) }} as clone_url,
    {{ json_extract_scalar('_airbyte_data', ['forks_url'], ['forks_url']) }} as forks_url,
    {{ json_extract_scalar('_airbyte_data', ['full_name'], ['full_name']) }} as full_name,
    {{ json_extract_scalar('_airbyte_data', ['has_pages'], ['has_pages']) }} as has_pages,
    {{ json_extract_scalar('_airbyte_data', ['hooks_url'], ['hooks_url']) }} as hooks_url,
    {{ json_extract_scalar('_airbyte_data', ['pulls_url'], ['pulls_url']) }} as pulls_url,
    {{ json_extract_scalar('_airbyte_data', ['pushed_at'], ['pushed_at']) }} as pushed_at,
    {{ json_extract_scalar('_airbyte_data', ['teams_url'], ['teams_url']) }} as teams_url,
    {{ json_extract_scalar('_airbyte_data', ['trees_url'], ['trees_url']) }} as trees_url,
    {{ json_extract_scalar('_airbyte_data', ['created_at'], ['created_at']) }} as created_at,
    {{ json_extract_scalar('_airbyte_data', ['events_url'], ['events_url']) }} as events_url,
    {{ json_extract_scalar('_airbyte_data', ['has_issues'], ['has_issues']) }} as has_issues,
    {{ json_extract_scalar('_airbyte_data', ['issues_url'], ['issues_url']) }} as issues_url,
    {{ json_extract_scalar('_airbyte_data', ['labels_url'], ['labels_url']) }} as labels_url,
    {{ json_extract_scalar('_airbyte_data', ['merges_url'], ['merges_url']) }} as merges_url,
    {{ json_extract_scalar('_airbyte_data', ['mirror_url'], ['mirror_url']) }} as mirror_url,
    {{ json_extract_scalar('_airbyte_data', ['updated_at'], ['updated_at']) }} as updated_at,
    {{ json_extract_scalar('_airbyte_data', ['visibility'], ['visibility']) }} as visibility,
    {{ json_extract_scalar('_airbyte_data', ['archive_url'], ['archive_url']) }} as archive_url,
    {{ json_extract_scalar('_airbyte_data', ['commits_url'], ['commits_url']) }} as commits_url,
    {{ json_extract_scalar('_airbyte_data', ['compare_url'], ['compare_url']) }} as compare_url,
    {{ json_extract_scalar('_airbyte_data', ['description'], ['description']) }} as description,
    {{ json_extract_scalar('_airbyte_data', ['forks_count'], ['forks_count']) }} as forks_count,
    {{ json_extract_scalar('_airbyte_data', ['is_template'], ['is_template']) }} as is_template,
    {{ json_extract('table_alias', '_airbyte_data', ['permissions'], ['permissions']) }} as permissions,
    {{ json_extract_scalar('_airbyte_data', ['branches_url'], ['branches_url']) }} as branches_url,
    {{ json_extract_scalar('_airbyte_data', ['comments_url'], ['comments_url']) }} as comments_url,
    {{ json_extract_scalar('_airbyte_data', ['contents_url'], ['contents_url']) }} as contents_url,
    {{ json_extract_scalar('_airbyte_data', ['git_refs_url'], ['git_refs_url']) }} as git_refs_url,
    {{ json_extract_scalar('_airbyte_data', ['git_tags_url'], ['git_tags_url']) }} as git_tags_url,
    {{ json_extract_scalar('_airbyte_data', ['has_projects'], ['has_projects']) }} as has_projects,
    {{ json_extract_scalar('_airbyte_data', ['releases_url'], ['releases_url']) }} as releases_url,
    {{ json_extract_scalar('_airbyte_data', ['statuses_url'], ['statuses_url']) }} as statuses_url,
    {{ json_extract_scalar('_airbyte_data', ['assignees_url'], ['assignees_url']) }} as assignees_url,
    {{ json_extract_scalar('_airbyte_data', ['downloads_url'], ['downloads_url']) }} as downloads_url,
    {{ json_extract_scalar('_airbyte_data', ['has_downloads'], ['has_downloads']) }} as has_downloads,
    {{ json_extract_scalar('_airbyte_data', ['languages_url'], ['languages_url']) }} as languages_url,
    {{ json_extract_scalar('_airbyte_data', ['default_branch'], ['default_branch']) }} as default_branch,
    {{ json_extract_scalar('_airbyte_data', ['milestones_url'], ['milestones_url']) }} as milestones_url,
    {{ json_extract_scalar('_airbyte_data', ['stargazers_url'], ['stargazers_url']) }} as stargazers_url,
    {{ json_extract_scalar('_airbyte_data', ['watchers_count'], ['watchers_count']) }} as watchers_count,
    {{ json_extract_scalar('_airbyte_data', ['deployments_url'], ['deployments_url']) }} as deployments_url,
    {{ json_extract_scalar('_airbyte_data', ['git_commits_url'], ['git_commits_url']) }} as git_commits_url,
    {{ json_extract_scalar('_airbyte_data', ['subscribers_url'], ['subscribers_url']) }} as subscribers_url,
    {{ json_extract_scalar('_airbyte_data', ['contributors_url'], ['contributors_url']) }} as contributors_url,
    {{ json_extract_scalar('_airbyte_data', ['issue_events_url'], ['issue_events_url']) }} as issue_events_url,
    {{ json_extract_scalar('_airbyte_data', ['stargazers_count'], ['stargazers_count']) }} as stargazers_count,
    {{ json_extract_scalar('_airbyte_data', ['subscription_url'], ['subscription_url']) }} as subscription_url,
    {{ json_extract_scalar('_airbyte_data', ['collaborators_url'], ['collaborators_url']) }} as collaborators_url,
    {{ json_extract_scalar('_airbyte_data', ['issue_comment_url'], ['issue_comment_url']) }} as issue_comment_url,
    {{ json_extract_scalar('_airbyte_data', ['notifications_url'], ['notifications_url']) }} as notifications_url,
    {{ json_extract_scalar('_airbyte_data', ['open_issues_count'], ['open_issues_count']) }} as open_issues_count,
    _airbyte_ab_id,
    _airbyte_emitted_at,
    {{ current_timestamp() }} as _airbyte_normalized_at
from {{ source('test_normalization', '_airbyte_raw_repositories') }} as table_alias
-- repositories
where 1 = 1

