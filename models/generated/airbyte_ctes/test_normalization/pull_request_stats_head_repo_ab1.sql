{{ config(
    cluster_by = "_airbyte_emitted_at",
    partition_by = {"field": "_airbyte_emitted_at", "data_type": "timestamp", "granularity": "day"},
    unique_key = '_airbyte_ab_id',
    schema = "_airbyte_test_normalization",
    tags = [ "nested-intermediate" ]
) }}
-- SQL model to parse JSON blob stored in a single column and extract into separated field columns as described by the JSON Schema
-- depends_on: {{ ref('pull_request_stats_head') }}
select
    _airbyte_head_hashid,
    {{ json_extract_scalar('repo', ['id'], ['id']) }} as id,
    {{ json_extract_scalar('repo', ['url'], ['url']) }} as url,
    {{ json_extract_scalar('repo', ['fork'], ['fork']) }} as fork,
    {{ json_extract_scalar('repo', ['name'], ['name']) }} as name,
    {{ json_extract_scalar('repo', ['size'], ['size']) }} as size,
    {{ json_extract_scalar('repo', ['forks'], ['forks']) }} as forks,
    {{ json_extract('table_alias', 'repo', ['owner'], ['owner']) }} as owner,
    {{ json_extract_array('repo', ['topics'], ['topics']) }} as topics,
    {{ json_extract_scalar('repo', ['git_url'], ['git_url']) }} as git_url,
    {{ json_extract('table_alias', 'repo', ['license'], ['license']) }} as license,
    {{ json_extract_scalar('repo', ['node_id'], ['node_id']) }} as node_id,
    {{ json_extract_scalar('repo', ['private'], ['private']) }} as private,
    {{ json_extract_scalar('repo', ['ssh_url'], ['ssh_url']) }} as ssh_url,
    {{ json_extract_scalar('repo', ['svn_url'], ['svn_url']) }} as svn_url,
    {{ json_extract_scalar('repo', ['archived'], ['archived']) }} as archived,
    {{ json_extract_scalar('repo', ['disabled'], ['disabled']) }} as disabled,
    {{ json_extract_scalar('repo', ['has_wiki'], ['has_wiki']) }} as has_wiki,
    {{ json_extract_scalar('repo', ['homepage'], ['homepage']) }} as homepage,
    {{ json_extract_scalar('repo', ['html_url'], ['html_url']) }} as html_url,
    {{ json_extract_scalar('repo', ['keys_url'], ['keys_url']) }} as keys_url,
    {{ json_extract('table_alias', 'repo', ['language']) }} as language,
    {{ json_extract_scalar('repo', ['tags_url'], ['tags_url']) }} as tags_url,
    {{ json_extract_scalar('repo', ['watchers'], ['watchers']) }} as watchers,
    {{ json_extract_scalar('repo', ['blobs_url'], ['blobs_url']) }} as blobs_url,
    {{ json_extract_scalar('repo', ['clone_url'], ['clone_url']) }} as clone_url,
    {{ json_extract_scalar('repo', ['forks_url'], ['forks_url']) }} as forks_url,
    {{ json_extract_scalar('repo', ['full_name'], ['full_name']) }} as full_name,
    {{ json_extract_scalar('repo', ['has_pages'], ['has_pages']) }} as has_pages,
    {{ json_extract_scalar('repo', ['hooks_url'], ['hooks_url']) }} as hooks_url,
    {{ json_extract_scalar('repo', ['pulls_url'], ['pulls_url']) }} as pulls_url,
    {{ json_extract_scalar('repo', ['pushed_at'], ['pushed_at']) }} as pushed_at,
    {{ json_extract_scalar('repo', ['teams_url'], ['teams_url']) }} as teams_url,
    {{ json_extract_scalar('repo', ['trees_url'], ['trees_url']) }} as trees_url,
    {{ json_extract_scalar('repo', ['created_at'], ['created_at']) }} as created_at,
    {{ json_extract_scalar('repo', ['events_url'], ['events_url']) }} as events_url,
    {{ json_extract_scalar('repo', ['has_issues'], ['has_issues']) }} as has_issues,
    {{ json_extract_scalar('repo', ['issues_url'], ['issues_url']) }} as issues_url,
    {{ json_extract_scalar('repo', ['labels_url'], ['labels_url']) }} as labels_url,
    {{ json_extract_scalar('repo', ['merges_url'], ['merges_url']) }} as merges_url,
    {{ json_extract_scalar('repo', ['mirror_url'], ['mirror_url']) }} as mirror_url,
    {{ json_extract_scalar('repo', ['updated_at'], ['updated_at']) }} as updated_at,
    {{ json_extract_scalar('repo', ['archive_url'], ['archive_url']) }} as archive_url,
    {{ json_extract_scalar('repo', ['commits_url'], ['commits_url']) }} as commits_url,
    {{ json_extract_scalar('repo', ['compare_url'], ['compare_url']) }} as compare_url,
    {{ json_extract_scalar('repo', ['description'], ['description']) }} as description,
    {{ json_extract_scalar('repo', ['forks_count'], ['forks_count']) }} as forks_count,
    {{ json_extract_scalar('repo', ['open_issues'], ['open_issues']) }} as open_issues,
    {{ json_extract('table_alias', 'repo', ['permissions'], ['permissions']) }} as permissions,
    {{ json_extract_scalar('repo', ['branches_url'], ['branches_url']) }} as branches_url,
    {{ json_extract_scalar('repo', ['comments_url'], ['comments_url']) }} as comments_url,
    {{ json_extract_scalar('repo', ['contents_url'], ['contents_url']) }} as contents_url,
    {{ json_extract_scalar('repo', ['git_refs_url'], ['git_refs_url']) }} as git_refs_url,
    {{ json_extract_scalar('repo', ['git_tags_url'], ['git_tags_url']) }} as git_tags_url,
    {{ json_extract_scalar('repo', ['has_projects'], ['has_projects']) }} as has_projects,
    {{ json_extract_scalar('repo', ['releases_url'], ['releases_url']) }} as releases_url,
    {{ json_extract_scalar('repo', ['statuses_url'], ['statuses_url']) }} as statuses_url,
    {{ json_extract_scalar('repo', ['allow_forking'], ['allow_forking']) }} as allow_forking,
    {{ json_extract_scalar('repo', ['assignees_url'], ['assignees_url']) }} as assignees_url,
    {{ json_extract_scalar('repo', ['downloads_url'], ['downloads_url']) }} as downloads_url,
    {{ json_extract_scalar('repo', ['has_downloads'], ['has_downloads']) }} as has_downloads,
    {{ json_extract_scalar('repo', ['languages_url'], ['languages_url']) }} as languages_url,
    {{ json_extract_scalar('repo', ['default_branch'], ['default_branch']) }} as default_branch,
    {{ json_extract_scalar('repo', ['milestones_url'], ['milestones_url']) }} as milestones_url,
    {{ json_extract_scalar('repo', ['stargazers_url'], ['stargazers_url']) }} as stargazers_url,
    {{ json_extract_scalar('repo', ['watchers_count'], ['watchers_count']) }} as watchers_count,
    {{ json_extract_scalar('repo', ['deployments_url'], ['deployments_url']) }} as deployments_url,
    {{ json_extract_scalar('repo', ['git_commits_url'], ['git_commits_url']) }} as git_commits_url,
    {{ json_extract_scalar('repo', ['subscribers_url'], ['subscribers_url']) }} as subscribers_url,
    {{ json_extract_scalar('repo', ['contributors_url'], ['contributors_url']) }} as contributors_url,
    {{ json_extract_scalar('repo', ['issue_events_url'], ['issue_events_url']) }} as issue_events_url,
    {{ json_extract_scalar('repo', ['stargazers_count'], ['stargazers_count']) }} as stargazers_count,
    {{ json_extract_scalar('repo', ['subscription_url'], ['subscription_url']) }} as subscription_url,
    {{ json_extract_scalar('repo', ['temp_clone_token'], ['temp_clone_token']) }} as temp_clone_token,
    {{ json_extract_scalar('repo', ['collaborators_url'], ['collaborators_url']) }} as collaborators_url,
    {{ json_extract_scalar('repo', ['issue_comment_url'], ['issue_comment_url']) }} as issue_comment_url,
    {{ json_extract_scalar('repo', ['notifications_url'], ['notifications_url']) }} as notifications_url,
    {{ json_extract_scalar('repo', ['open_issues_count'], ['open_issues_count']) }} as open_issues_count,
    {{ json_extract_scalar('repo', ['allow_merge_commit'], ['allow_merge_commit']) }} as allow_merge_commit,
    {{ json_extract_scalar('repo', ['allow_rebase_merge'], ['allow_rebase_merge']) }} as allow_rebase_merge,
    {{ json_extract_scalar('repo', ['allow_squash_merge'], ['allow_squash_merge']) }} as allow_squash_merge,
    _airbyte_ab_id,
    _airbyte_emitted_at,
    {{ current_timestamp() }} as _airbyte_normalized_at
from {{ ref('pull_request_stats_head') }} as table_alias
-- repo at pull_request_stats/head/repo
where 1 = 1
and repo is not null

